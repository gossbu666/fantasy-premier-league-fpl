# Fantasy Premier League Predictor

Machine learning-powered FPL squad optimizer with live predictions from the official FPL API. This project uses **safe-3seasons models** (trained on 2021â€“22 to 2023â€“24, evaluated on 2024â€“25) to predict player expected points and optimize a 15-player squad under a 100m budget.

## Features

- ðŸ”® **Live predictions** â€“ Fetch current FPL data and predict expected points for all players
- ðŸ§® **Squad optimizer** â€“ Find the optimal 15-player team (2 GK, 5 DEF, 5 MID, 3 FWD) under 100m budget
- âš½ **Starting XI suggestions** â€“ Get recommended 4-3-3 formation with highest expected points
- ðŸ“Š **Position-specific models** â€“ Separate XGBoost models for GK, DEF, MID, FWD

## Installation

### Prerequisites

- Python 3.9 or higher
- pip
- virtualenv (recommended)

### Setup

```bash
# Clone the repository
git clone <your-repo-url>
cd fantasy-premier-league-fpl

# Create and activate virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

## Project structure

```text
fantasy-premier-league-fpl/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ processed/
â”‚       â””â”€â”€ players_predictions_live.csv   # Generated by refresh script
â”œâ”€â”€ flask_app/
â”‚   â”œâ”€â”€ app.py                            # Streamlit UI (main application)
â”‚   â””â”€â”€ build_players_predictions_live.py # Data fetch and prediction script
â”œâ”€â”€ models/                               # Pre-trained ML models (*.pkl)
â”‚   â”œâ”€â”€ GK_safe_3seasons_train_202425_test.pkl
â”‚   â”œâ”€â”€ DEF_safe_3seasons_train_202425_test.pkl
â”‚   â”œâ”€â”€ MID_safe_3seasons_train_202425_test.pkl
â”‚   â””â”€â”€ FWD_safe_3seasons_train_202425_test.pkl
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## Running the application

### 1. Start the Streamlit app

From the project root:

```bash
source venv/bin/activate
cd flask_app
streamlit run app.py
```

The app will open in your browser at `http://localhost:8501`.

### 2. Using the optimizer

#### Step 1: Refresh live predictions

Click **ðŸ”„ Refresh live predictions** to:
- Fetch latest player data from the official FPL API
- Generate features for all active players
- Run position-specific machine learning models
- Save predictions to `data/processed/players_predictions_live.csv`

This may take 30â€“60 seconds depending on the number of active players.

#### Step 2: Optimize squad

Click **ðŸ§® Optimize 100m squad** to:
- Solve a mixed-integer linear program (MILP) that maximizes total expected points
- Respect budget constraint (99m â‰¤ cost â‰¤ 100m to use budget efficiently)
- Enforce squad composition: 2 GK, 5 DEF, 5 MID, 3 FWD
- Limit to maximum 3 players per Premier League team

The optimizer returns:
- **15-player squad** with total cost and aggregated expected points
- **Suggested starting XI** in 4-3-3 formation with the highest predicted performers

## Model details

### Training approach

- **Training data**: Seasons 2021â€“22, 2022â€“23, 2023â€“24
- **Evaluation data**: Season 2024â€“25 (no data leakage)
- **Model type**: XGBoost regressors (one per position)
- **Features**: 
  - Rolling averages (1, 3, 5, 10 gameweeks) of points, goals, assists, BPS, ICT metrics
  - Team-level rolling statistics (goals scored, goals conceded)
  - Fixture difficulty rating (FDR attack/defense)
  - Player metadata (cost, position, team, opponent, home/away status)

### Safe-3seasons methodology

Models are trained **exclusively on past seasons** (2021â€“22 to 2023â€“24) and **never see 2024â€“25 data during training**. This ensures:
- No data leakage from future information
- Realistic performance evaluation on the current season
- Production-ready predictions suitable for live gameweeks

## Optimization constraints

The MILP optimizer enforces official FPL squad rules:

| Constraint | Value |
|------------|-------|
| Total budget | â‰¤ 100.0m |
| Minimum spend | â‰¥ 99.0m |
| Goalkeepers | 2 |
| Defenders | 5 |
| Midfielders | 5 |
| Forwards | 3 |
| Max per team | 3 |

The objective is to **maximize the total predicted points** across all 15 players.

## Troubleshooting

### Error: "File not found: players_predictions_live.csv"

Solution: Click **Refresh live predictions** first. This creates the required CSV file.

### Refresh button fails with an error

Check the error message displayed in the UI. Common causes:
- FPL API is temporarily unavailable or rate-limiting requests
- Missing model files in the `models/` directory
- Missing Python packages (reinstall with `pip install -r requirements.txt`)

### Optimizer returns no feasible solution

- Verify the predictions file exists and contains valid data
- Check if budget constraints are too restrictive
- Try increasing `MIN_SPEND` or decreasing `BUDGET` in `flask_app/app.py`

## Development

### Adding custom features

To extend the feature engineering pipeline:
1. Edit the feature generation logic in `flask_app/build_players_predictions_live.py`
2. Update position-specific feature builders if needed
3. Retrain models with the new feature set

### Retraining models

Models were originally trained using `train_safe_3seasons_vs_202425.py`. To retrain:

```bash
python train_safe_3seasons_vs_202425.py
```

New models will be saved to the `models/` directory.

## Contributing

Contributions are welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Submit a pull request

## License

Educational use. FPL data is sourced from the official Fantasy Premier League API.

## Acknowledgments

- [Fantasy Premier League](https://fantasy.premierleague.com/) for the official API
- [PuLP](https://github.com/coin-or/pulp) for the linear programming solver
- [Streamlit](https://streamlit.io/) for the web application framework

---

**Disclaimer**: This optimizer provides expected points based on historical patterns and machine learning models. Actual FPL performance depends on many unpredictable factors (injuries, player form, tactical changes, rotation policy, etc.). Use predictions as guidance, not as guaranteed outcomes.
